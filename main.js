(()=>{"use strict";let e=[];const t=document.querySelector(".elements"),r=(document.querySelector("#cards-tempalte").content,document.querySelector(".popup_type_img-popup")),n=document.querySelector(".profile__info"),o=document.querySelector(".popup_type_author"),s=(o.querySelector(".popup__submit-btn"),n.querySelector(".profile__title"),o.querySelector(".popup__input_type_description")),i=(n.querySelector(".profile__subtitle"),o.querySelector(".popup__input_type_name")),a=document.querySelector(".profile__edit-button"),l=(o.querySelector(".popup__close-btn"),document.querySelector(".popup_type_add-place")),c=document.querySelector(".profile__add-button"),u=l.querySelector(".popup__submit-btn"),p=(l.querySelector(".popup__close-btn"),r.querySelector(".popup__img-title"),r.querySelector(".popup__picture"),document.querySelectorAll(".popup__overlay"),document.querySelector(".profile__avatar")),_=document.querySelector(".profile__avatar-edit"),h=".popup_type_edit-avatar",d=document.querySelector(h).querySelector(".popup__submit-btn"),m=o.querySelector(".popup__form_type_author"),v=document.querySelector(".popup__form_type_add-place"),S=document.querySelector(".popup__form_type_edit-avatar"),y=v.querySelector(".popup__input_type_place-name"),g=v.querySelector(".popup__input_type_photo"),f={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__submit-btn",inactiveButtonClass:"popup__submit-btn_condition_inactive",inputErrorClass:"popup__input_condition_warning",errorClass:"popup__input-warning_active",inputErrorSelector:".popup__input_condition_warning",errorSelector:".popup__input-warning_active"};class E{constructor(e,t,r,n,o,s,i){this._cardSelector=t,this._name=e.name,this._link=e.link,this._likes=e.likes,this.owner_id=e.owner._id,this._id=e._id,this._handleCardClick=r,this._handleRemoveBtnClick=n,this._userId=o,this._addLike=s,this._removeLike=i}_getTemplate(){return document.querySelector(this._cardSelector).content.cloneNode(!0)}_likeButtonClick(e){const t=e.target.closest(".element__likes").querySelector(".element__like-counter");e.target.classList.contains("element__like-btn_active")?this._removeLike(this._id).then((()=>{e.target.classList.remove("element__like-btn_active"),t.textContent=parseInt(t.textContent)-1})).catch((e=>{console.log(`Ошибка удаления лайка: ${e}`)})):this._addLike(this._id).then((()=>{e.target.classList.add("element__like-btn_active"),t.textContent=parseInt(t.textContent)+1})).catch((e=>{console.log(`Ошибка добавления лайка: ${e}`)}))}_removeButtonClick(){this._handleRemoveBtnClick(this.card)}_setEventListeners(e,t,r){e.querySelector(".element__like-btn").addEventListener("click",(e=>{this._likeButtonClick(e)})),t.addEventListener("click",this._handleCardClick),r||r.addEventListener("click",this._handleRemoveBtnClick)}createCard(){const e=this._getTemplate(),t=e.querySelector(".element__picture"),r=e.querySelector(".element__remove-btn");return this._id,t.src=this._link,t.alt=this._name,e.querySelector(".element").id=this._id,e.querySelector(".element__title").textContent=this._name,e.querySelector(".element__like-counter").textContent=this._likes.length,this._likes.forEach((t=>{t._id===this._userId&&e.querySelector(".element__like-btn").classList.add("element__like-btn_active")})),this.owner_id!==this._userId&&r.remove(),this._setEventListeners(e,t,r),e}}class C{constructor(e){this._popupContainer=document.querySelector(e),this._handleEscClose=this._handleEscClose.bind(this)}_handleEscClose(e){"Escape"===e.key&&this.close()}open(){this._popupContainer.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popupContainer.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}setEventListeners(){this._popupContainer.querySelector(".popup__close-btn").addEventListener("click",(()=>{this.close()})),this._popupContainer.querySelector(".popup__overlay").addEventListener("click",(()=>{this.close()}))}}class k extends C{constructor(e,t){super(e),this._popupContainer=document.querySelector(e),this._submitFormHandler=t,this._form=this._popupContainer.querySelector(".popup__form")}_getInputValues(){const e=this._form.elements,t={};for(let r=0;r<e.length;r++)("INPUT"===e[r].nodeName&&"text"===e[r].type||"url"===e[r].type)&&(t[e[r].name]=e[r].value);return t}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{this._submitFormHandler(e,this._getInputValues())}))}close(){super.close(),this._form.reset()}}class b{constructor(e,t){this._validationSettings=e,this._form=t,this._inputList=Array.from(this._form.querySelectorAll(this._validationSettings.inputSelector)),this._buttonElement=this._form.querySelector(this._validationSettings.submitButtonSelector),this._errorElement}_showInputError(e,t){this._errorElement=this._form.querySelector(`.popup__input-warning_type_${e.name}`),e.classList.add(this._validationSettings.inputErrorClass),this._errorElement.textContent=t,this._errorElement.classList.add(this._validationSettings.errorClass),this._toggleButtonState()}_checkInputValidity(e){e.validity.valid?this._hideInputError(e):this._showInputError(e,e.validationMessage)}_hasInvalidInput(){return this._inputList.some((e=>!e.validity.valid))}_toggleButtonState(){this._hasInvalidInput()?(this._buttonElement.classList.add(this._validationSettings.inactiveButtonClass),this._buttonElement.disabled=!0):(this._buttonElement.classList.remove(this._validationSettings.inactiveButtonClass),this._buttonElement.disabled=!1)}_hideInputError(e){this._errorElement=this._form.querySelector(`.popup__input-warning_type_${e.name}`),e.classList.remove(this._validationSettings.inputErrorClass),this._errorElement.classList.remove(this._validationSettings.errorClass),this._errorElement.textContent=""}_setEventListeners(){this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this._toggleButtonState()}))}))}clearWarnings(){const e=this._form.querySelectorAll(this._validationSettings.errorSelector);e.length>0&&(e.forEach((e=>{e.classList.remove(this._validationSettings.errorClass)})),this._form.querySelectorAll(this._validationSettings.inputErrorSelector).forEach((e=>{e.classList.remove(this._validationSettings.inputErrorClass)})))}enableValidation(){this._form.addEventListener("submit",(function(e){e.preventDefault()})),this._setEventListeners()}}const L=e=>e.ok?e.json():Promise.reject(`Error: ${e.status}`),q=new class{constructor(e){this.apiSettings=e}getCards(){return fetch(this.apiSettings.cardsUrl,{headers:{authorization:this.apiSettings.token}}).then(L).catch((e=>{console.log(`Загрузка карточек. Ошибка: ${e}`)}))}addNewCard(e,t){return fetch(this.apiSettings.cardsUrl,{method:"POST",headers:{authorization:this.apiSettings.token,"Content-Type":"application/json"},body:JSON.stringify({name:e,link:t})}).then(L).catch((e=>{console.log(`Добавление карточки. Ошибка: ${e}`)}))}getUserInfo(){return fetch(this.apiSettings.userUrl,{headers:{authorization:this.apiSettings.token}}).then(L).catch((e=>{console.log(`Загрузка информации о пользователе. Ошибка: ${e}`)}))}sendUserInfo(e,t){return fetch(this.apiSettings.userUrl,{method:"PATCH",headers:{authorization:this.apiSettings.token,"Content-Type":"application/json"},body:JSON.stringify({name:e,about:t})}).then(L).catch((e=>{console.log(`Сохранение информации о пользователе. Ошибка: ${e}`)}))}removeCard(e){return fetch(`${this.apiSettings.cardsUrl}/${e}`,{method:"DELETE",headers:{authorization:this.apiSettings.token}}).then(L).catch((e=>{console.log(`Удаление карточки. Ошибка: ${e}`)}))}addLike(e){return fetch(`${this.apiSettings.cardsLikeUrl}/${e}`,{method:"PUT",headers:{authorization:this.apiSettings.token}}).then(L).catch((e=>{console.log(`Добавление лайка. Ошибка: ${e}`)}))}removeLike(e){return fetch(`${this.apiSettings.cardsLikeUrl}/${e}`,{method:"DELETE",headers:{authorization:this.apiSettings.token}}).then(L).catch((e=>{console.log(`Удаление лайка. Ошибка: ${e}`)}))}updateAvatar(e){return fetch(this.apiSettings.updateAvatarUrl,{method:"PATCH",headers:{authorization:this.apiSettings.token,"Content-Type":"application/json"},body:JSON.stringify({avatar:e})}).then(L).catch((e=>{console.log(`Обновление аватара. Ошибка: ${e}`)}))}}({token:"d3c067e5-dfe9-4c66-9aca-7fc30c1afb49",groupId:"cohort-21",url:"https://mesto.nomoreparties.co/v1/",cardsUrl:"https://mesto.nomoreparties.co/v1/cohort-21/cards",cardsLikeUrl:"https://mesto.nomoreparties.co/v1/cohort-21/cards/likes",userUrl:"https://mesto.nomoreparties.co/v1/cohort-21/users/me",updateAvatarUrl:"https://mesto.nomoreparties.co/v1/cohort-21/users/me/avatar"});function I(e){return new E(e,"#cards-tempalte",D.open.bind(D),w,B._userId,U,$)}function w(e){x.open(e)}function U(e){return q.addLike(e)}function $(e){return q.removeLike(e)}Promise.all([q.getUserInfo(),q.getCards()]).then((([t,r])=>{B.setUserInfo(t.name,t.about,t._id),B.setUserAvatar(t.avatar),r.forEach((t=>{e.push(t)})),A.renderItems()})).catch((e=>{console.log(`Ошибка загрузки данных: ${e}`)}));const x=new class extends C{constructor(e,t){super(e),this._popupContainer=document.querySelector(e),this._submitFormHandler=t,this._form=this._popupContainer.querySelector(".popup__form")}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",this._submitFormHandler)}open(e){super.open(),this._card=e.target.parentElement}cardId(){return this._card}}(".popup_type_remove-card",(e=>{e.preventDefault(),console.log(x.cardId()),q.removeCard(x.cardId().id).then((()=>{x.cardId().remove(),x.close()}))})),A=new class{constructor(e,{data:t,renderer:r}){this._container=e,this._items=t,this._renderer=r}addItem(e){this._container.prepend(e)}renderItems(){this._items.forEach((e=>{this._renderer(e)}))}}(t,{data:e,renderer:e=>{const t=I(e).createCard();A.addItem(t)}}),B=new class{constructor(e){this._nameSelector=e.name,this._authorInfoSelector=e.authorInfo,this._authorAvatarSelector=e.avatar,this._authorName=document.querySelector(this._nameSelector),this._authorInfo=document.querySelector(this._authorInfoSelector),this._authorAvatar=document.querySelector(this._authorAvatarSelector),this._userId=null}getUserInfo(){const e={};return e.name=this._authorName.textContent,e.info=this._authorInfo.textContent,e}setUserInfo(e,t,r){this._authorName.textContent=e,this._authorInfo.textContent=t,this._userId=r}setUserAvatar(e){this._authorAvatar.src=e}userId(){return this._userId}}({name:".profile__title",authorInfo:".profile__subtitle",avatar:".profile__avatar"}),N=new k(".popup_type_author",(function(e,t){e.preventDefault();const r=e.target.querySelector(".popup__submit-btn");r.value="Сохранение...",q.sendUserInfo(t.authorName,t.athorDescription).then((e=>{B.setUserInfo(e.name,e.about)})).catch((e=>{console.log(`Сохранение информации об авторе. Ошибка: ${e}`)})).finally((()=>{r.value="Сохранить",N.close()}))})),T=new k(h,(function(e,t){e.preventDefault();const r=e.target.querySelector(".popup__submit-btn");r.value="Сохранение...",q.updateAvatar(t.avatar).then((()=>{p.src=t.avatar})).catch((e=>{console.log(`Сохранение информации об авторе. Ошибка: ${e}`)})).finally((()=>{r.value="Сохранить",T.close()}))})),z=new k(".popup_type_add-place",(e=>{e.preventDefault();const t=e.target.querySelector(".popup__submit-btn");t.value="Сохранение...";const r={};r.name=y.value,r.link=g.value,q.addNewCard(r.name,r.link).then((e=>{const t=I(e).createCard();A.addItem(t)})).catch((e=>{console.log(`Сохранение информации об авторе. Ошибка: ${e}`)})).finally((()=>{t.value="Создать",z.close()}))})),D=new class extends C{open(e){const t=e.target.alt,r=this._popupContainer.querySelector(".popup__picture");r.src=e.target.src,r.alt=t,this._popupContainer.querySelector(".popup__img-title").textContent=t,super.open()}}(".popup_type_img-popup"),V=new b(f,m);V.enableValidation();const P=new b(f,v);P.enableValidation();const H=new b(f,S);H.enableValidation(),a.addEventListener("click",(()=>{i.value=B.getUserInfo().name,s.value=B.getUserInfo().info,V.clearWarnings(),N.open()})),c.addEventListener("click",(()=>{u.disabled=!0,u.classList.add(f.inactiveButtonClass),z.open(),P.clearWarnings()})),_.addEventListener("click",(()=>{d.disabled=!0,d.classList.add(f.inactiveButtonClass),T.open(),H.clearWarnings()})),N.setEventListeners(),D.setEventListeners(),z.setEventListeners(),x.setEventListeners(),T.setEventListeners()})();